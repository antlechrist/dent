#!/bin/sh
#
# Based on identibash

. ~/.dentrc

MAXITEMS=5
PUBURL="http://identi.ca/${user}/all/rss"
POSTURL="http://identi.ca/api/statuses/update.xml"
TMPFILE=~/.dent.tmp
EXCLUDE="${user} and friends"

readpub() {
	clear
	curl -s $PUBURL > $TMPFILE
	count=0
	echo "-------------------------------------------"
	while read line; do
		if $(echo "${line}" | grep -v "$EXCLUDE" | grep -q "title>"); then
			echo "${line}" | sed 's/<title>//g' | sed 's/<\/title>//g'
		fi

		if $(echo "${line}" | grep -v "$EXCLUDE" | grep -q "description>"); then
			echo -n "${line}" | sed 's/<description>//g' | sed 's/<\/description>//g'
		fi

		if $(echo "${line}" | grep -q "dc:creator>"); then
			echo "${line}" | sed 's/<dc:creator>/ by: /g' | sed 's/<\/dc:creator>//g'
		fi

		if $(echo "${line}" | grep -q "</item>"); then
			echo "-------------------------------------------"
			count=$((count + 1))
			if [ $count -eq $MAXITEMS ]; then
				break
			fi
		fi
	done < $TMPFILE
}

postmsg() {
	curl -s -u ${user}:${pass} -d status="$msg" ${POSTURL} 2>&1>/dev/null
}

getopts "rp:" flag
case "${flag}" in
	r) readpub ;;
	p) msg=${OPTARG}; postmsg; readpub ;;
esac
